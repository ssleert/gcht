<html>
  <head>
    <title>
      gcht - funny chat
    </title>

    <style>
      * {
        padding: 10px;
        background-color: black;
        color: white;
        font-size: 25px;
      }

      #msgs-container {
        overflow: scroll;
        max-height: 60vh;
      }
    </style>
  </head>
  <body>
    <div id="msgs-container">
      <pre id="msgs">
CONNECTED TO CHAT
      </pre>
    </div>
    <form id="f">
      user:
      <br />
      <input id="u" type="text" />
      <br />
      message:
      <br />
      <input id="m" type="text" />
      <br />
      <br />
      <button>
        send
      </button>
    </form>
  </body>
  <script>
    let msgs = document.getElementById("msgs");
    let idx = 0;

    let u = document.getElementById("u");
    let m = document.getElementById("m");
    let t = document.getElementById("t");
    let f = document.getElementById("f");

    let sendMsg = () => {
      let raw = JSON.stringify({
        "u": u.value,
        "m": m.value,
      });

      fetch(`http://${window.location.host}/api/new_message`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: raw,
      });

      m.value = "";
    };

    f.onclick = (e) => (e.preventDefault(), sendMsg());

    (async () => {
      do {
        await new Promise((r) => setTimeout(r, 1000));
        try {
          let r = await fetch(
            `http://${window.location.host}/api/get_messages/${idx}`,
            {
              method: "GET",
            },
          );

          let data = await r.json();
          if (data.length == 0) {
            continue;
          }

          if (idx == 0) {
            idx = data[0].i;
          }

          for (let msg of data) {
            if (idx >= msg.i) {
              continue;
            }

            idx = msg.i;
            msgs.innerHTML += `\n ${msg.u}: ${msg.m}`;
          }
        } catch (err) {
          console.log(err);
        }
      } while (true);
    })();
  </script>
</html>
